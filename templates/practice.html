<!doctype html>
<html lang="en" x-data="practicePage()" x-init="init()" :class="dark ? 'theme-dark' : ''">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>üéØ Practice ‚Äî IntervYou</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4F46E5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
  <script src="/static/pwa-install.js" defer></script>

  <!-- Tailwind + Alpine -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    [x-cloak]{display:none!important;}
    @keyframes gradientMove {
      0%,100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .animate-gradient {
      background-size: 200% 200%;
      animation: gradientMove 12s ease infinite;
    }
    .fade-slide-up {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeUp 1s ease forwards;
    }
    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* small card-hover effect for category tiles */
    .card-hover { transition: transform .12s ease, box-shadow .12s ease; }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(2,6,23,0.06); }

    /* visually indicate active category */
    .cat-active { outline: 2px solid rgba(99,102,241,0.18); box-shadow: 0 6px 18px rgba(99,102,241,0.08); }
  </style>
</head>

<body class="bg-gray-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 antialiased">

  <!-- ====== NAVBAR ====== -->
  <nav class="fixed top-0 left-0 w-full z-50 flex justify-between items-center px-6 py-4 bg-transparent">
    <div @click="goHome" class="cursor-pointer hover:scale-105 transition-transform">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-sky-400 to-blue-500 grid place-items-center text-white font-bold shadow-md">AI</div>
        <span class="text-white font-semibold text-lg drop-shadow">IntervYou</span>
      </div>
    </div>
  </nav>

  <!-- Profile Icon - Top Right Corner -->
  <a href="/profile" class="fixed top-6 right-6 z-[1001] group" aria-label="Profile">
    <div class="w-12 h-12 rounded-full bg-white dark:bg-slate-800 border-2 border-sky-400 dark:border-sky-500 
                flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-300 
                hover:scale-110 cursor-pointer backdrop-blur-sm">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500 dark:text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
    </div>
    <!-- Tooltip -->
    <div class="absolute top-full right-0 mt-2 px-3 py-1 bg-slate-900 text-white text-sm rounded-lg 
                opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Profile
    </div>
  </a>

  <!-- ====== HERO / LAYOUT CONTAINER ====== -->
  <header class="relative min-h-[95vh] flex items-center justify-center overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-indigo-500 via-sky-400 to-emerald-300 animate-gradient"></div>
    <div class="absolute inset-0 bg-black/40"></div>

    <div class="relative z-10 w-full max-w-7xl px-6 grid grid-cols-1 lg:grid-cols-3 gap-10 items-start mt-20">

      <!-- ====== LEFT: Category grid or practice card ====== -->
      <main class="lg:col-span-2">

        <!-- CATEGORY-SELECTION GRID (shows when not in practice mode) -->
        <section x-show="!started" x-cloak class="mb-8">
          <div class="bg-white/80 dark:bg-slate-800/80 rounded-2xl p-8 shadow-xl border border-slate-100 dark:border-slate-700">
            <div class="text-center mb-4">
              <h1 class="text-3xl font-extrabold text-slate-800 dark:text-white">üéØ Practice</h1>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Pick a category to start practicing questions.</p>
            </div>

            <!-- Company Filter -->
            <div class="mb-6 flex items-center justify-center gap-3">
              <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">üè¢ Target Company:</label>
              <select x-model="selectedCompany" @change="filterByCompany()" 
                      class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-400 outline-none">
                <option value="">All Companies</option>
                <template x-for="company in companiesList" :key="company">
                  <option :value="company" x-text="company"></option>
                </template>
              </select>
              <span x-show="selectedCompany" class="text-xs text-indigo-600 dark:text-indigo-400" x-text="'Showing ' + selectedCompany + ' questions'"></span>
            </div>

            <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4">
              <!-- Render tiles from server-provided list into a JS array for Alpine -->
              <template x-for="cat in categoriesList" :key="cat">
                <button @click="choose(cat)"
                        class="card-hover text-left p-6 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:bg-indigo-50 dark:hover:bg-slate-700 transition"
                        :class="selectedCandidate === cat ? 'cat-active' : ''"
                        @mouseover="selectedCandidate = cat"
                        @mouseleave="selectedCandidate = null">
                  <div class="text-sm font-semibold text-slate-900 dark:text-white" x-text="cat"></div>
                </button>
              </template>
            </div>

            <div class="mt-6 text-sm text-slate-500 dark:text-slate-400 text-center">
              Tip: You can click any tile to open practice for that category. Use the right panel for quick actions.
            </div>
          </div>
        </section>

        <!-- MAIN PRACTICE CARD (shows when a category is chosen) -->
        <section x-show="started" x-cloak class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 border border-slate-100 dark:border-slate-700 fade-slide-up">
          <div class="flex items-start justify-between mb-4">
            <div>
              <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-indigo-600" x-text="selectedCategory"></h1>
                <!-- Company Badge -->
                <span x-show="selectedCompany" 
                      class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300">
                  üè¢ <span x-text="selectedCompany"></span>
                </span>
              </div>
              <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                <span x-show="!selectedCompany">Answer this question ‚Äî use the text box or record your voice.</span>
                <span x-show="selectedCompany" x-text="'Practicing ' + selectedCompany + '-specific questions'"></span>
              </p>
              <!-- Difficulty Level Badge -->
              <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold"
                   :class="{
                     'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300': currentDifficulty === 'beginner',
                     'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300': currentDifficulty === 'intermediate',
                     'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': currentDifficulty === 'advanced'
                   }">
                <span x-text="currentDifficulty === 'beginner' ? 'üå±' : currentDifficulty === 'intermediate' ? '‚ö°' : 'üî•'"></span>
                <span x-text="currentDifficulty.toUpperCase()"></span>
                <span class="text-xs opacity-75" x-text="'(' + questionsAtLevel + ' answered)'"></span>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button @click="resetToCategories()" class="text-sm text-slate-400 hover:text-indigo-600">‚¨Ö Back</button>
              <div class="text-xs text-slate-400">‚è± <strong x-text="timeLeft"></strong>s</div>
            </div>
          </div>

          <!-- QUESTION BOX -->
          <div class="p-5 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 mb-6">
            <p id="questionText" class="text-base font-medium text-slate-800 dark:text-slate-100" x-text="question">Loading question...</p>
            <div class="mt-3 flex gap-3 items-center">
              <button @click="playQuestion()" class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 transition">
                üîä Play Question
              </button>

              <!-- Save question button (shows saved/saving states) -->
              <button @click="saveQuestion()" class="px-4 py-2 rounded-lg border text-sm font-semibold transition"
                      :class="questionSaved ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white/10 text-slate-100 border-white/10'">
                <template x-if="savingInProgress">Saving‚Ä¶</template>
                <template x-if="!savingInProgress">
                  <span x-text="questionSaved ? 'Saved' : '‚≠ê Save Question'"></span>
                </template>
              </button>

              <div class="ml-auto text-xs text-slate-400">Progress <strong x-text="progress + '%'"></strong></div>
            </div>
          </div>

          <!-- ANSWER AREA -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
            <div>
              <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">‚úçÔ∏è Type your answer</label>
              <!-- Enter submits (Shift+Enter for newline) -->
              <textarea
                x-model="answerText"
                placeholder="Write your answer here..."
                class="mt-2 w-full h-40 p-4 text-sm rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-400 outline-none"
                @keydown.enter.prevent="if(!$event.shiftKey) submitTextAnswer()"
              ></textarea>
              <div class="mt-3 flex gap-3">
                <button @click="submitTextAnswer()" class="px-5 py-2.5 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition">Submit</button>
                <button @click="nextQuestion()" class="px-5 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:opacity-90 transition">Next</button>
                <button @click="playFeedbackAudio()" class="px-4 py-2 rounded-lg border text-sm ml-auto" x-show="feedbackAudioUrl">üîä Play Feedback</button>
              </div>
            </div>

            <!-- VOICE -->
            <div>
              <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">üéôÔ∏è Record & Transcribe</label>
              <div class="mt-2">
                <button @click="toggleRecording()" 
                        class="px-8 py-3 rounded-lg font-semibold transition-all shadow-lg"
                        :class="recording ? 'bg-slate-700 text-white hover:bg-slate-600' : 'bg-gradient-to-r from-indigo-500 to-sky-400 text-white hover:opacity-90'">
                  <span x-show="!recording">üéôÔ∏è Record</span>
                  <span x-show="recording">‚èπÔ∏è Stop & Transcribe</span>
                </button>
                <div x-show="transcribing" class="mt-3 text-sm text-indigo-600 dark:text-indigo-400">
                  ‚è≥ Transcribing with Whisper AI...
                </div>
              </div>
            </div>
          </div>

          <!-- FEEDBACK -->
          <div class="p-5 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-sm">
            <div x-html="renderedFeedback || 'AI feedback will appear here after you submit.'"></div>
            <div class="mt-3 flex items-center justify-between">
              <span class="text-xs text-slate-400">Score: <strong x-text="lastScore !== null ? (Math.round(lastScore * 10) / 10) + '/10' : '‚Äî'"></strong></span>
              <div>
                <button @click="copyFeedback()" class="text-xs px-3 py-1 rounded-lg bg-white/10">Copy</button>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- ====== RIGHT: Sidebar ====== -->
      <aside class="space-y-6 fade-slide-up" style="animation-delay:.3s">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 border border-slate-100 dark:border-slate-700">
          <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">üí° Practice Tips</h3>
          <ul class="text-sm text-slate-600 dark:text-slate-300 space-y-2">
            <li>üß© Focus on one topic per session.</li>
            <li>üéß Listen to your recorded answers.</li>
            <li>üó£Ô∏è Speak clearly and naturally.</li>
            <li>‚≠ê Save questions you want to revisit.</li>
          </ul>
        </div>

        <div class="bg-gradient-to-br from-indigo-50 to-white dark:from-slate-700 dark:to-slate-800 rounded-2xl p-6 shadow">
          <h4 class="text-sm font-semibold text-indigo-700 dark:text-indigo-300 mb-3">Quick Actions</h4>
          <button @click="resetToCategories()" class="block w-full px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm mb-2">Choose Category</button>
          <a href="/mock_interview" class="block w-full px-4 py-2 rounded-lg bg-white/10 text-sm">Start Mock Interview</a>
        </div>
      </aside>
    </div>
  </header>

  <footer class="text-center text-sm text-white/80 py-6 mt-6 relative z-10">
    ¬© {{ now().year if now else '2025' }} IntervYou ‚Äî Practice. Improve. Succeed.
  </footer>

  <!-- Small fallback toast utility -->
  <script>
    (function(){
      if (!window.showToast) {
        window.showToast = function(msg, opts = {}) {
          const id = 'iv-toast-fallback';
          let container = document.getElementById(id);
          if (!container) {
            container = document.createElement('div');
            container.id = id;
            container.style.position = 'fixed';
            container.style.right = '18px';
            container.style.bottom = '18px';
            container.style.zIndex = 99999;
            document.body.appendChild(container);
          }
          const el = document.createElement('div');
          el.style.marginTop = '8px';
          el.style.minWidth = '160px';
          el.style.background = 'rgba(15,23,42,0.95)';
          el.style.color = 'white';
          el.style.padding = '10px 12px';
          el.style.borderRadius = '8px';
          el.style.boxShadow = '0 6px 20px rgba(2,6,23,0.4)';
          el.style.fontSize = '13px';
          el.textContent = msg;
          container.appendChild(el);
          const lifetime = (opts.duration || 2500);
          setTimeout(()=> {
            try { container.removeChild(el); } catch(e){}
          }, lifetime);
        }
      }
    })();
  </script>

  <!-- Alpine.js Logic -->
  <script>
    function practicePage() {
      return {
        dark: false,
        // Companies list from server
        companiesList: {{ companies|tojson|safe }},
        selectedCompany: '',
        // server-provided categories made available to Alpine; fallback contains an expanded set
        categoriesList: (typeof {{ categories|tojson|safe }} !== 'undefined' && {{ categories|tojson|safe }} && {{ categories|tojson|safe }}.length) ? {{ categories|tojson|safe }} : [
          "Banking Interview / Aptitude",
          "HR Interview / Behavioral",
          "Aptitude / Quant",
          "Technical (Frontend)",
          "Technical (Backend)",
          "Technical (Data / DevOps)",
          "AI / ML",
          "Data Science",
          "System Design",
          "DevOps / SRE",
          "Case / Consulting",
          "Product Management",
          "Finance / Banking",
          "Campus / Fresher (HR Aptitude)",
          "Communication & Presentation",
          "Situational / Leadership",
          "Security / InfoSec",
          "Embedded Systems",
          "Sales & Marketing",
          "Customer Success / Support",
          "Design / UX",
          "Quality Assurance / Testing"
        ],
        selectedCandidate: null,
        selectedCategory: '',
        question: 'Loading...',
        answerText: '',
        renderedFeedback: '',
        feedbackAudioUrl: null,
        lastScore: null,
        recording: false,
        transcribing: false,
        mediaRecorder: null,
        recordingBlob: null,
        lastRecordingUrl: null,
        audioStream: null,
        timeLeft: 150,
        progress: 0,
        timer: null,
        
        // Difficulty level system
        currentDifficulty: 'beginner',  // beginner, intermediate, advanced
        difficultyScore: 0,  // Track performance for level progression
        questionsAtLevel: 0,  // Questions answered at current level

        // category / UI control
        started: false,

        // saving UI
        questionSaved: false,
        savingInProgress: false,

        toggleTheme() {
          this.dark = !this.dark;
          document.documentElement.classList.toggle('dark', this.dark);
          localStorage.setItem('iv_theme', this.dark ? 'dark' : 'light');
        },

        goHome() { window.location.href = '/'; },

        async init() {
          // init theme from localStorage
          this.dark = localStorage.getItem('iv_theme') === 'dark';
          document.documentElement.classList.toggle('dark', this.dark);

          // Ensure categoriesList is an array even if server didn't render it
          try {
            if (!Array.isArray(this.categoriesList) || !this.categoriesList.length) {
              this.categoriesList = [
                "Banking Interview / Aptitude",
                "HR Interview / Behavioral",
                "Aptitude / Quant",
                "Technical (Frontend)",
                "Technical (Backend)",
                "Technical (Data / DevOps)",
                "AI / ML",
                "Data Science",
                "System Design",
                "DevOps / SRE",
                "Case / Consulting",
                "Product Management",
                "Finance / Banking",
                "Campus / Fresher (HR Aptitude)",
                "Communication & Presentation",
                "Situational / Leadership",
                "Security / InfoSec",
                "Embedded Systems",
                "Sales & Marketing",
                "Customer Success / Support",
                "Design / UX",
                "Quality Assurance / Testing"
              ];
            }
          } catch (e) {
            // ignore
          }

          // Preload default question (not starting timer)
          try {
            const res = await fetch('/get_mock_question?index=0');
            if (res.ok) {
              const d = await res.json();
              this.question = d.question || "Explain a programming concept you're comfortable with.";
            } else {
              this.question = "Explain a programming concept you're comfortable with.";
            }
          } catch (e) {
            this.question = "Explain a programming concept you're comfortable with.";
          }
        },

        // Filter questions by company
        async filterByCompany() {
          // Clear cache when company changes to force fresh questions
          try {
            // Always clear cache when company changes
            await fetch('/clear_question_cache', { method: 'POST' });
            console.log('‚úÖ Cache cleared after company change');
            
            if (this.started && this.selectedCategory) {
              // User is already practicing, reload with new company
              window.showToast(`Switching to ${this.selectedCompany || 'all companies'}...`);
              await this.setCategoryOnServer(this.selectedCategory, true); // force_refresh = true
              await this.loadQuestion();
            } else {
              // Just show notification
              if (this.selectedCompany) {
                window.showToast(`Filtering for ${this.selectedCompany} questions`);
              } else {
                window.showToast('Showing all companies');
              }
            }
          } catch (e) {
            console.error('Cache clear failed:', e);
          }
        },

        // choose a category from the grid
        async choose(cat) {
          if (!cat) return window.showToast('Select a category first.');
          this.selectedCategory = cat;
          this.started = true;
          await this.setCategoryOnServer(cat);
          await this.loadQuestion();
        },

        async setCategoryOnServer(cat, forceRefresh = false) {
          try {
            const payload = { category: cat };
            if (this.selectedCompany) {
              payload.company = this.selectedCompany;
            }
            if (forceRefresh) {
              payload.force_refresh = true; // Force new question generation
            }
            await fetch('/set_category', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
            });
          } catch (e) {
            // non-critical
            console.warn('set_category failed', e);
          }
        },

        async resetToCategories() {
          this.started = false;
          this.answerText = '';
          this.renderedFeedback = '';
          this.questionSaved = false;
          try { clearInterval(this.timer); } catch(e){}
          
          // Clear cache when returning to category selection
          // This ensures fresh questions when selecting a new category
          try {
            await fetch('/clear_question_cache', { method: 'POST' });
            console.log('‚úÖ Cache cleared on reset');
          } catch (e) {
            console.error('Cache clear failed:', e);
          }
        },

        async loadQuestion() {
          try {
            const res = await fetch('/get_mock_question?index=0');
            const data = await res.json();
            this.question = data.question || `Explain a concept from ${this.selectedCategory}.`;
            this.questionSaved = false;
            this.startTimer();
          } catch {
            this.question = `Explain a concept from ${this.selectedCategory}.`;
            this.questionSaved = false;
            this.startTimer();
          }
        },

        startTimer() {
          try { clearInterval(this.timer); } catch(e){}
          this.timeLeft = 150;  // Increased from 60s to 150s
          this.progress = 0;
          this.timer = setInterval(() => {
            this.timeLeft--;
            this.progress = Math.round(100 * (150 - this.timeLeft) / 150);
            if (this.timeLeft <= 0) {
              clearInterval(this.timer);
              // optionally auto-submit if user wrote answer
              if (this.answerText && this.answerText.trim()) {
                this.submitTextAnswer();
              }
            }
          }, 1000);
        },

        // ---------- Submitting & feedback ----------
        async submitTextAnswer() {
          const msg = this.answerText.trim();
          if (!msg) return window.showToast('Please type your answer.');
          
          // Stop the timer when submitting
          try { clearInterval(this.timer); } catch(e){}
          
          // send to server for evaluation
          try {
            const res = await fetch('/evaluate_answer', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ question_text: this.question, answer: msg })
            });
            if (!res.ok) {
              // fallback to /chat if evaluate fails
              const chatRes = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg })
              });
              const chatJson = await chatRes.json();
              this._renderChatFallback(chatJson);
              return;
            }
            const js = await res.json();
            const evalObj = js.evaluation || {};
            const plag = js.plagiarism_score;
            let html = '';
            if (evalObj.summary) html += `<strong>Summary:</strong> <div class="mt-1">${this._escapeHtml(evalObj.summary)}</div>`;
            if (Array.isArray(evalObj.improvements) && evalObj.improvements.length) {
              html += `<div class="mt-2"><strong>Improvements:</strong><ul class="mt-1">` + evalObj.improvements.map(i => `<li>${this._escapeHtml(i)}</li>`).join('') + `</ul></div>`;
            }
            if (plag != null) {
              html += `<div class="mt-2"><strong>Similarity:</strong> ${ (plag*100).toFixed(1) }%</div>`;
              if (js.matches && js.matches.length) {
                html += `<details class="mt-2"><summary>Matches (${js.matches.length})</summary><ul>` +
                  js.matches.slice(0,5).map(m => `<li>${this._escapeHtml(m.source || m.id || 'src')} ‚Äî score:${(m.sim||0).toFixed(3)} ‚Äî ${ this._escapeHtml((m.excerpt||'').slice(0,120)) }</li>`).join('') +
                  `</ul></details>`;
              }
            }
            this.renderedFeedback = html || '<div class="text-sm">No feedback returned.</div>';
            this.feedbackAudioUrl = evalObj.audio_feedback_url || evalObj.audio_url || null;
            this.lastScore = evalObj.score ? Math.round(evalObj.score * 10) / 10 : null;
            
            // Difficulty progression logic
            this.updateDifficultyLevel(this.lastScore);
            
            window.showToast('Evaluation received');
          } catch (err) {
            console.error('submitTextAnswer error', err);
            window.showToast('Evaluation failed.');
          }
        },
        
        // Difficulty level progression system
        updateDifficultyLevel(score) {
          if (score === null || score === undefined) return;
          
          this.questionsAtLevel++;
          this.difficultyScore += score;
          
          const avgScore = this.difficultyScore / this.questionsAtLevel;
          const minQuestionsForPromotion = 3;  // Need at least 3 questions to promote
          
          // Promotion logic
          if (this.questionsAtLevel >= minQuestionsForPromotion) {
            if (this.currentDifficulty === 'beginner' && avgScore >= 7.0) {
              // Promote to intermediate
              this.currentDifficulty = 'intermediate';
              this.questionsAtLevel = 0;
              this.difficultyScore = 0;
              window.showToast('üéâ Promoted to INTERMEDIATE level!', { duration: 4000 });
              this.loadQuestionWithDifficulty();
            } else if (this.currentDifficulty === 'intermediate' && avgScore >= 8.0) {
              // Promote to advanced
              this.currentDifficulty = 'advanced';
              this.questionsAtLevel = 0;
              this.difficultyScore = 0;
              window.showToast('üî• Promoted to ADVANCED level!', { duration: 4000 });
              this.loadQuestionWithDifficulty();
            }
          }
          
          // Demotion logic (if struggling)
          if (this.questionsAtLevel >= 5 && avgScore < 4.0) {
            if (this.currentDifficulty === 'advanced') {
              this.currentDifficulty = 'intermediate';
              this.questionsAtLevel = 0;
              this.difficultyScore = 0;
              window.showToast('‚ö†Ô∏è Moved back to INTERMEDIATE level', { duration: 4000 });
              this.loadQuestionWithDifficulty();
            } else if (this.currentDifficulty === 'intermediate') {
              this.currentDifficulty = 'beginner';
              this.questionsAtLevel = 0;
              this.difficultyScore = 0;
              window.showToast('‚ö†Ô∏è Moved back to BEGINNER level', { duration: 4000 });
              this.loadQuestionWithDifficulty();
            }
          }
        },
        
        async loadQuestionWithDifficulty() {
          // Load question with current difficulty level
          try {
            const res = await fetch('/set_category', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ 
                category: this.selectedCategory,
                difficulty: this.currentDifficulty,
                force_refresh: true
              })
            });
            if (res.ok) {
              const data = await res.json();
              if (data.next_question) {
                this.question = data.next_question;
                this.questionSaved = false;
                this.startTimer();
              }
            }
          } catch (e) {
            console.warn('loadQuestionWithDifficulty failed', e);
          }
        },

        _renderChatFallback(chatJson) {
          let html = '';
          if (chatJson.reply) html += `<div class="mb-2">${this._escapeHtml(chatJson.reply)}</div>`;
          if (chatJson.score !== undefined && chatJson.score !== null) {
            const roundedScore = Math.round(chatJson.score * 10) / 10;
            html += `<div><strong>Score:</strong> ${roundedScore}/10</div>`;
            this.lastScore = roundedScore;
          }
          this.renderedFeedback = html || '<div class="text-sm">No feedback.</div>';
        },

        playQuestion() {
          try {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(this.question);
            window.speechSynthesis.speak(u);
          } catch (e) {
            console.warn('playQuestion failed', e);
          }
        },

        playFeedbackAudio() {
          if (this.feedbackAudioUrl) new Audio(this.feedbackAudioUrl).play();
        },

        copyFeedback() {
          try {
            navigator.clipboard.writeText(this.renderedFeedback.replace(/<[^>]+>/g, ''));
            window.showToast('Feedback copied');
          } catch (e) {
            window.showToast('Could not copy');
          }
        },

        // ---------- Save question (optimistic UI) ----------
        async saveQuestion() {
          if (this.questionSaved || this.savingInProgress) return;
          this.savingInProgress = true;
          this.questionSaved = true; // optimistic
          window.showToast('Saving question‚Ä¶');

          try {
            const payload = { question: this.question };
            const res = await fetch('/save_question', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              // revert
              this.questionSaved = false;
              this.savingInProgress = false;
              let txt = '';
              try { txt = await res.text(); } catch(e){ txt = res.status; }
              window.showToast('Save failed: ' + (txt || res.status), { duration: 3500 });
              return;
            }

            const js = await res.json().catch(()=>null);
            window.showToast(js && js.message ? js.message : 'Saved!');
            this.savingInProgress = false;
            this.questionSaved = true;
          } catch (err) {
            console.error('saveQuestion error', err);
            this.questionSaved = false;
            this.savingInProgress = false;
            window.showToast('Save failed (network).');
          }
        },

        // ---------- Recording & Transcription ----------
        async toggleRecording() {
          if (!this.recording) {
            // Start recording
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              this.audioStream = stream;
              this.mediaRecorder = new MediaRecorder(stream);
              const chunks = [];
              
              this.mediaRecorder.ondataavailable = e => chunks.push(e.data);
              this.mediaRecorder.onstop = async () => {
                this.recordingBlob = new Blob(chunks, { type: 'audio/webm' });
                // Auto-transcribe after stopping
                await this.autoTranscribe();
                // Stop all tracks
                if (this.audioStream) {
                  this.audioStream.getTracks().forEach(track => track.stop());
                }
              };
              
              this.mediaRecorder.start();
              this.recording = true;
              window.showToast('üéôÔ∏è Recording...');
            } catch (err) {
              window.showToast('Could not access microphone: ' + (err.message || err));
              console.error('Recording error:', err);
            }
          } else {
            // Stop recording and transcribe
            if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
              this.mediaRecorder.stop();
              this.recording = false;
            }
          }
        },

        async autoTranscribe() {
          if (!this.recordingBlob) {
            window.showToast('No recording to transcribe');
            return;
          }
          
          this.transcribing = true;
          window.showToast('Transcribing with Whisper AI...');
          
          try {
            const fd = new FormData();
            fd.append('file', this.recordingBlob, 'answer.webm');
            
            const response = await fetch('/transcribe', {
              method: 'POST',
              body: fd
            });
            
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
              window.showToast(data.error);
              return;
            }
            
            if (data.transcription) {
              this.answerText = data.transcription;
              window.showToast(`‚úÖ Transcribed ${data.word_count || 0} words`);
              this.renderedFeedback = `<strong>üé§ Transcription:</strong><div class="mt-2 p-3 bg-white dark:bg-slate-900 rounded-lg">${this._escapeHtml(data.transcription)}</div>`;
            } else {
              window.showToast('No speech detected');
            }
          } catch (err) {
            console.error('Transcription error:', err);
            window.showToast('Transcription failed: ' + err.message);
          } finally {
            this.transcribing = false;
          }
        },



        // ---------- Navigation: next question ----------
        async nextQuestion() {
          this.answerText = '';
          this.renderedFeedback = '';
          this.questionSaved = false;
          try {
            const res = await fetch('/get_mock_question?index=' + Math.floor(Math.random() * 10));
            const d = await res.json();
            this.question = d.question || `Explain a concept from ${this.selectedCategory}.`;
            // restart timer
            this.startTimer();
          } catch (e) {
            this.question = `Explain a concept from ${this.selectedCategory}.`;
            this.startTimer();
          }
        },

        // ---------- tiny helpers ----------
        _escapeHtml(str) {
          if (!str) return '';
          return String(str).replace(/[&<>"']/g, function (s) {
            return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s];
          });
        }
      };
    }
  </script>
</body>
</html>
